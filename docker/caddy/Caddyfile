# Laravel main domain (proxied to Nginx)
app.elbayoumi.net, www.app.elbayoumi.net {
    encode gzip
    reverse_proxy web:80
}

# Socket.IO on sub-subdomain (proxied to Node)
ws.app.elbayoumi.net {
    encode gzip

    # Route only socket.io paths
    @socket path /socket.io*
    reverse_proxy @socket socket:3001

    # (Optional) Preflight for XHR fallback
    @preflight {
        method OPTIONS
        header Origin *
        path /socket.io*
    }
    handle @preflight {
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization"
        respond "" 204
    }

    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "no-referrer-when-downgrade"
    }
}
